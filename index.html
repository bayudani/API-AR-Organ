<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Marker Generator - Skripsi Edition (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        .font-tech {
            font-family: 'Space Grotesk', sans-serif;
        }

        .card-template {
            width: 350px; 
            height: 550px;
            position: relative;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            /* Force print background colors */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            display: flex;
            flex-direction: column;
        }

        .ar-border {
            border: 12px solid #1f2937; 
        }

        /* Hexagon Styles */
        .clip-hex {
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        
        .hex-btn {
            width: 36px;
            height: 40px;
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hex-btn:hover { transform: scale(1.1); filter: brightness(1.1); }
        .hex-btn.active {
            transform: scale(1.15);
            filter: brightness(1.2);
            z-index: 10;
            box-shadow: inset 0 0 0 2px white;
        }
        .hex-btn.active::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free"; 
            font-weight: 900;
            color: white;
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .corner-marker {
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 80px 80px;
            border-color: transparent transparent currentColor transparent;
            position: absolute;
            bottom: 0;
            right: 0;
            z-index: 10;
        }

        .bg-pattern {
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Responsive Preview Area */
        .preview-container {
            transform-origin: center center;
        }
        @media (max-width: 1000px) {
            .preview-container { transform: scale(0.8); }
        }
        @media (max-width: 800px) {
            .preview-container { transform: scale(0.65); }
        }

        /* --- PRINT STYLES REWORKED --- */
        @media print {
            @page {
                size: A4 portrait;
                margin: 0.5cm; /* Sedikit margin buat printer rumahan */
            }

            /* Sembunyikan elemen UI (Sidebar & Container Background) */
            .no-print, 
            .sidebar-controls,
            body > .bg-slate-100 { 
                display: none !important; 
            }

            body {
                background: white;
                height: 100vh;
                overflow: hidden;
            }

            /* --- Mode: Print Batch (4 Kartu) --- */
            body.printing-batch #print-batch {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(2, 1fr);
                width: 100%; /* Full width A4 printable area */
                height: 98vh; /* Hampir full height */
                padding: 0;
                gap: 0; /* Hapus gap, kita atur pake padding kartu aja klo perlu */
                position: absolute;
                top: 0;
                left: 0;
                background: white;
                z-index: 9999;
                align-items: center;
                justify-items: center;
            }

            /* Styling kartu di dalam batch */
            body.printing-batch .queued-card {
                /* Scale AGRESIF ke 0.6 biar fix muat 4 biji */
                transform: scale(0.6) !important; 
                transform-origin: center center;
                box-shadow: none !important;
                border: 2px solid #1f2937 !important; /* Border tipis hemat tinta */
                
                /* Negative margin buat ngurangin bounding box "ghost" dari transform */
                margin: -40px !important; 
                
                page-break-inside: avoid;
            }

            /* Sembunyikan area preview single saat mode batch */
            body.printing-batch #print-area {
                display: none !important;
            }


            /* --- Mode: Print Single (Satuan) --- */
            body:not(.printing-batch) #print-area {
                display: flex !important;
                align-items: flex-start;
                justify-content: center;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 9999;
                padding-top: 50px;
            }

            body:not(.printing-batch) #marker-card {
                transform: scale(1) !important;
                box-shadow: none !important;
                border: 4px solid #1f2937 !important;
            }
            
            /* Hide overlay patterns saat print single */
            body:not(.printing-batch) .absolute.inset-0 {
                display: none;
            }
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col md:flex-row">

    <!-- SIDEBAR CONTROLS (Tambahin class sidebar-controls buat targeting print) -->
    <div class="sidebar-controls w-full md:w-1/3 p-6 bg-white border-r border-slate-200 overflow-y-auto flex flex-col gap-4 z-20 shadow-lg scrollbar-thin h-full">
        <div>
            <h1 class="text-2xl font-bold font-tech text-indigo-600 mb-1">
                <i class="fa-solid fa-cube mr-2"></i>AR Marker Gen
            </h1>
            <p class="text-xs text-slate-500">Buat marker skripsi aesthetic & print 4-up.</p>
        </div>

        <!-- Form Controls -->
        <div class="space-y-3">
            <div class="flex gap-4">
                 <div class="flex-1">
                    <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Nama Aplikasi</label>
                    <input type="text" id="input-app-name" value="BIOLENS AR" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-bold" oninput="updateMarker()">
                </div>
                 <div class="w-20">
                    <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">No. Kartu</label>
                    <input type="text" id="input-card-num" value="01" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" oninput="updateMarker()">
                </div>
            </div>

            <!-- Hexagonal Color Picker -->
            <div>
                <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Warna Tema</label>
                <div class="flex flex-wrap gap-2" id="hex-palette">
                    <div class="hex-btn active bg-[#4f46e5]" onclick="changeColor(this, '#4f46e5')"></div>
                    <div class="hex-btn bg-[#ef4444]" onclick="changeColor(this, '#ef4444')"></div>
                    <div class="hex-btn bg-[#f59e0b]" onclick="changeColor(this, '#f59e0b')"></div>
                    <div class="hex-btn bg-[#10b981]" onclick="changeColor(this, '#10b981')"></div>
                    <div class="hex-btn bg-[#06b6d4]" onclick="changeColor(this, '#06b6d4')"></div>
                    <div class="hex-btn bg-[#d946ef]" onclick="changeColor(this, '#d946ef')"></div>
                    <div class="hex-btn bg-[#1e293b]" onclick="changeColor(this, '#1e293b')"></div>
                </div>
                <input type="hidden" id="input-color" value="#4f46e5">
            </div>

            <div class="border-t border-slate-200 pt-3">
                <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Nama Organ (Judul)</label>
                <input type="text" id="input-title" value="RONGGA MULUT" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-extrabold uppercase" oninput="updateMarker()">
            </div>

            <div>
                <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Sub-Judul (Sistem)</label>
                <input type="text" id="input-sub" value="Sistem Pencernaan Manusia" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" oninput="updateMarker()">
            </div>

            <div>
                <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Gambar Organ</label>
                <div class="relative group">
                    <input type="file" id="image-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleImageUpload(event)">
                    <div class="w-full px-3 py-2 border-2 border-dashed border-slate-300 rounded-lg text-center group-hover:border-indigo-500 group-hover:bg-indigo-50 transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-up text-slate-400"></i>
                        <span class="block text-xs text-slate-500 font-medium">Ganti Gambar</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRINT BATCH MANAGER -->
        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mt-2">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-indigo-900 text-xs uppercase flex items-center gap-1">
                    <i class="fa-solid fa-layer-group"></i> Antrean Cetak (A4)
                </h3>
                <span id="queue-count" class="bg-indigo-200 text-indigo-800 text-[10px] px-2 py-0.5 rounded-full font-bold">0/4</span>
            </div>
            
            <div id="queue-list" class="space-y-1 mb-3 min-h-[20px]">
                <p id="empty-msg" class="text-[10px] text-indigo-400 italic text-center py-2">Belum ada kartu di antrean.</p>
            </div>

            <div class="flex gap-2">
                 <button onclick="addToQueue()" id="btn-add-queue" class="flex-1 py-2 bg-white border border-indigo-200 text-indigo-600 text-xs font-bold rounded-lg hover:bg-indigo-600 hover:text-white transition shadow-sm">
                    <i class="fa-solid fa-plus mr-1"></i> Tambah ke Kertas
                </button>
                <button onclick="clearQueue()" class="px-3 py-2 bg-white text-red-500 border border-red-200 text-xs font-bold rounded-lg hover:bg-red-50 transition shadow-sm" title="Reset Antrean">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        </div>

        <div class="mt-auto pt-4 flex flex-col gap-2 pb-6">
             <button onclick="downloadImage()" class="w-full py-2.5 bg-slate-800 text-white text-sm rounded-xl font-bold hover:bg-slate-900 transition shadow-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-image"></i> Simpan JPG (Satuan)
            </button>
            <button onclick="handlePrint()" id="btn-print-action" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-print"></i> Print PDF (Satuan)
            </button>
        </div>
    </div>

    <!-- PREVIEW AREA -->
    <div class="flex-1 bg-slate-100 relative flex items-center justify-center p-8 overflow-hidden">
        <!-- Grid Background -->
        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#cbd5e1 1px, transparent 1px), linear-gradient(90deg, #cbd5e1 1px, transparent 1px); background-size: 40px 40px;"></div>

        <!-- THE MARKER CARD (Visible Editor) -->
        <div class="preview-container" id="print-area">
            <div id="marker-card" class="card-template bg-white rounded-none ar-border overflow-hidden">
                
                <!-- Card Header -->
                <div class="px-6 py-5 flex justify-between items-center border-b-2 border-slate-100 z-10 bg-white">
                    <div class="flex items-center gap-2">
                        <div id="logo-icon" class="w-10 h-10 bg-indigo-600 flex items-center justify-center text-white clip-hex">
                            <img src="iconapk.png" alt="">
                        </div>
                        <span id="card-app-name" class="font-tech font-bold text-lg tracking-wider text-slate-800">BIOLENS AR</span>
                    </div>
                    <span id="card-num-display" class="bg-slate-800 text-white text-xs font-bold px-2 py-1 rounded font-mono">#01</span>
                </div>

                <!-- Main Image Area -->
                <div class="flex-1 p-4 flex items-center justify-center relative bg-pattern">
                    <div class="w-full h-full border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-center bg-white/50 relative overflow-hidden group">
                        <img id="marker-image" crossorigin="anonymous" src="https://img.freepik.com/free-vector/human-mouth-open-realistic-illustration_1284-59368.jpg" alt="Organ Preview" class="max-w-[80%] max-h-[80%] object-contain drop-shadow-xl filter contrast-125">
                        
                        <!-- Watermarks -->
                        <div class="absolute top-2 left-2 w-4 h-4 border-t-2 border-l-2 border-slate-400"></div>
                        <div class="absolute top-2 right-2 w-4 h-4 border-t-2 border-r-2 border-slate-400"></div>
                        <div class="absolute bottom-2 left-2 w-4 h-4 border-b-2 border-l-2 border-slate-400"></div>
                        <div class="absolute bottom-2 right-2 w-4 h-4 border-b-2 border-r-2 border-slate-400"></div>
                    </div>
                </div>

                <!-- Card Footer -->
                <div class="p-6 bg-white z-10 border-t-2 border-slate-100 relative">
                    <h2 id="card-title" class="text-3xl font-extrabold text-slate-800 uppercase leading-none mb-2 tracking-tight">RONGGA MULUT</h2>
                    <p id="card-sub" class="text-slate-500 font-medium text-sm flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span>
                        Sistem Pencernaan Manusia
                    </p>
                    
                    <div id="corner-shape" class="corner-marker text-indigo-600"></div>
                    
                     <div class="absolute bottom-6 right-20 opacity-20">
                        <i class="fa-solid fa-qrcode text-4xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- HIDDEN BATCH CONTAINER FOR PRINTING (Direct Child of Body is better for z-indexing) -->
        <!-- Moved this dynamically via script, but keeping placeholder here isn't enough, we rely on the one below -->
    </div>
    
    <!-- PRINT BATCH CONTAINER (Outside flex container) -->
    <div id="print-batch" class="hidden"></div>

    <script>
        // --- QUEUE SYSTEM ---
        let printQueue = [];
        const MAX_QUEUE = 4;

        function addToQueue() {
            if (printQueue.length >= MAX_QUEUE) {
                alert("Satu kertas A4 maksimal 4 kartu, bro! Print dulu atau hapus antrean.");
                return;
            }

            const sourceCard = document.getElementById('marker-card');
            const title = document.getElementById('input-title').value;
            const cardNum = document.getElementById('input-card-num').value;
            const currentColor = document.getElementById('input-color').value; // Ambil warna saat ini
            
            // 1. Clone node
            const clonedCard = sourceCard.cloneNode(true);
            
            // 2. Bersihin ID biar gak konflik
            clonedCard.removeAttribute('id');
            clonedCard.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));
            
            // 3. Tambah class khusus
            clonedCard.classList.add('queued-card');
            
            // 4. [CRITICAL FIX] Apply warna manual ke elemen clone karena class Tailwind dinamis kadang gak kebawa sempurna di clone
            const clonedLogo = clonedCard.querySelector('.clip-hex');
            const clonedCorner = clonedCard.querySelector('.corner-marker');
            
            if(clonedLogo) {
                clonedLogo.style.backgroundColor = currentColor;
                // Force print color
                clonedLogo.style.printColorAdjust = 'exact'; 
                clonedLogo.style.webkitPrintColorAdjust = 'exact';
            }
            if(clonedCorner) {
                clonedCorner.style.color = currentColor;
            }

            // Simpan ke array
            printQueue.push({
                id: Date.now(),
                title: title,
                num: cardNum,
                element: clonedCard
            });

            updateQueueUI();
            
            // Feedback UI button
            const btn = document.getElementById('btn-add-queue');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Masuk!';
            btn.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-200');
            }, 1000);
        }

        function removeFromQueue(index) {
            printQueue.splice(index, 1);
            updateQueueUI();
        }

        function clearQueue() {
            if(confirm("Yakin mau hapus semua antrean cetak?")) {
                printQueue = [];
                updateQueueUI();
            }
        }

        function updateQueueUI() {
            const listEl = document.getElementById('queue-list');
            const countEl = document.getElementById('queue-count');
            const emptyMsg = document.getElementById('empty-msg');
            const printBtn = document.getElementById('btn-print-action');

            countEl.innerText = `${printQueue.length}/${MAX_QUEUE}`;
            listEl.innerHTML = '';
            
            if (printQueue.length === 0) {
                // Tampilkan pesan kosong jika tidak ada antrean
                const p = document.createElement('p');
                p.id = "empty-msg";
                p.className = "text-[10px] text-indigo-400 italic text-center py-2";
                p.innerText = "Belum ada kartu di antrean.";
                listEl.appendChild(p);
                
                printBtn.innerHTML = '<i class="fa-solid fa-print"></i> Print PDF (Satuan)';
                printBtn.classList.replace('bg-indigo-800', 'bg-indigo-600'); // Reset warna
            } else {
                printBtn.innerHTML = `<i class="fa-solid fa-print"></i> Print Batch (${printQueue.length} Kartu)`;
                printBtn.classList.replace('bg-indigo-600', 'bg-indigo-800'); // Gelapin dikit tanda batch mode
                
                printQueue.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-white p-2 rounded border border-indigo-100 text-[10px]";
                    div.innerHTML = `
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="font-bold bg-indigo-100 text-indigo-700 px-1 rounded">#${item.num}</span>
                            <span class="truncate font-medium">${item.title}</span>
                        </div>
                        <button onclick="removeFromQueue(${index})" class="text-red-400 hover:text-red-600 px-1">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;
                    listEl.appendChild(div);
                });
            }
        }

        function handlePrint() {
            const batchContainer = document.getElementById('print-batch');
            
            // Logic Toggle Mode Print
            if (printQueue.length > 0) {
                // MODE BATCH
                document.body.classList.add('printing-batch');
                batchContainer.innerHTML = ''; 
                printQueue.forEach(item => {
                    batchContainer.appendChild(item.element);
                });
            } else {
                // MODE SINGLE
                document.body.classList.remove('printing-batch');
                batchContainer.innerHTML = ''; // Bersihkan container batch
            }

            // Delay dikit biar DOM render dulu sebelum dialog print muncul
            setTimeout(() => {
                window.print();
            }, 100);

            // Cleanup setelah print (menggunakan event listener lebih aman)
            window.onafterprint = function() {
                document.body.classList.remove('printing-batch');
            };
            
            // Fallback cleanup (karena onafterprint gak jalan di semua browser/situasi)
            setTimeout(() => {
                document.body.classList.remove('printing-batch');
            }, 5000);
        }

        // --- GENERAL ---

        function changeColor(element, colorHex) {
            document.querySelectorAll('.hex-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('input-color').value = colorHex;
            updateMarker();
        }

        function updateMarker() {
            const appName = document.getElementById('input-app-name').value;
            const cardNum = document.getElementById('input-card-num').value;
            const title = document.getElementById('input-title').value;
            const sub = document.getElementById('input-sub').value;
            const color = document.getElementById('input-color').value;

            document.getElementById('card-app-name').innerText = appName || 'APP NAME';
            document.getElementById('card-num-display').innerText = '#' + cardNum;
            document.getElementById('card-title').innerText = title || 'JUDUL ORGAN';
            document.getElementById('card-sub').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span> ${sub || 'Kategori'}`;
            
            document.getElementById('logo-icon').style.backgroundColor = color;
            document.getElementById('corner-shape').style.color = color;
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('marker-image');
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        function downloadImage() {
            const markerElement = document.getElementById('marker-card');
            const btn = document.querySelector('button[onclick="downloadImage()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            
            html2canvas(markerElement, {
                scale: 2, 
                useCORS: true, 
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'AR-Marker-' + document.getElementById('input-title').value + '.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                btn.innerHTML = originalText;
            }).catch(err => {
                console.error(err);
                alert('Gagal save gambar. Coba upload gambar lokal.');
                btn.innerHTML = originalText;
            });
        }
    </script>
</body>
</html>